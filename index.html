<!-- APEX Box Breathing Animation V5 - FINAL -->
<style>
    .apex-breathing-trigger-wrapper {
        text-align: center;
        padding: 40px 20px;
    }
    
    .apex-breathing-trigger {
        background: linear-gradient(135deg, #ECBD66 0%, #d4a94f 100%);
        color: #0F0F0F;
        border: none;
        padding: 18px 40px;
        font-size: 18px;
        font-weight: bold;
        border-radius: 8px;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(236, 189, 102, 0.3);
        transition: all 0.3s ease;
        font-family: Arial, sans-serif;
    }
    
    .apex-breathing-trigger:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(236, 189, 102, 0.4);
    }
    
    .apex-breathing-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(15, 15, 15, 0.95);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }
    
    .apex-breathing-overlay.active {
        display: flex;
    }
    
    .apex-config-screen {
        text-align: center;
    }
    
    .apex-config-title {
        color: #ECBD66;
        font-size: 32px;
        font-weight: bold;
        margin-bottom: 40px;
        font-family: Arial, sans-serif;
    }
    
    .apex-config-controls {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        margin-bottom: 40px;
    }
    
    .apex-triangle-btn {
        width: 0;
        height: 0;
        border-left: 30px solid transparent;
        border-right: 30px solid transparent;
        background: none;
        cursor: pointer;
        transition: all 0.3s ease;
        padding: 0;
        outline: none;
        border-style: solid;
    }
    
    .apex-triangle-btn.up {
        border-bottom: 40px solid #ECBD66;
        border-top: none;
    }
    
    .apex-triangle-btn.down {
        border-top: 40px solid #ECBD66;
        border-bottom: none;
    }
    
    .apex-triangle-btn:hover {
        opacity: 0.8;
        transform: scale(1.1);
    }
    
    .apex-config-value {
        color: #E8E6E3;
        font-size: 64px;
        font-weight: bold;
        font-family: Arial, sans-serif;
        min-width: 100px;
        text-align: center;
    }
    
    .apex-config-label {
        color: #999999;
        font-size: 18px;
        margin-top: 10px;
        font-family: Arial, sans-serif;
    }
    
    .apex-start-btn {
        background: linear-gradient(135deg, #ECBD66 0%, #d4a94f 100%);
        color: #0F0F0F;
        border: none;
        padding: 18px 50px;
        font-size: 20px;
        font-weight: bold;
        border-radius: 8px;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(236, 189, 102, 0.3);
        transition: all 0.3s ease;
        font-family: Arial, sans-serif;
    }
    
    .apex-start-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(236, 189, 102, 0.4);
    }
    
    .apex-breathing-screen {
        display: none;
    }
    
    .apex-breathing-screen.active {
        display: block;
    }
    
    .apex-breathing-container {
        position: relative;
        text-align: center;
        margin-bottom: 40px;
    }
    
    .apex-breathing-box {
        position: relative;
        width: 300px;
        height: 300px;
        margin: 0 auto;
        border: 4px solid #ECBD66;
        border-radius: 12px;
        overflow: visible;
    }
    
    .apex-breathing-fill {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 0%;
        background: linear-gradient(to top, rgba(236, 189, 102, 0.3), rgba(236, 189, 102, 0.15));
        transition: height 4s linear;
        z-index: 1;
        border-radius: 8px;
    }
    
    .apex-breathing-fill.paused {
        transition: none;
    }
    
    .apex-breathing-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #E8E6E3;
        font-size: 32px;
        font-weight: bold;
        font-family: Arial, sans-serif;
        z-index: 5;
    }
    
    .apex-breathing-ball {
        position: absolute;
        width: 24px;
        height: 24px;
        background: linear-gradient(135deg, #ECBD66 0%, #fff 100%);
        border-radius: 50%;
        box-shadow: 0 0 20px rgba(236, 189, 102, 0.8);
        top: calc(100% - 12px);
        left: -12px;
        z-index: 100;
        transition: all 4s linear;
    }
    
    .apex-breathing-ball.paused {
        transition: none !important;
    }
    
    .apex-breathing-controls {
        display: flex;
        gap: 20px;
        justify-content: center;
    }
    
    .apex-breathing-btn {
        background: rgba(236, 189, 102, 0.2);
        border: 2px solid #ECBD66;
        color: #E8E6E3;
        width: 60px;
        height: 60px;
        font-size: 28px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: Arial, sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }
    
    .apex-breathing-btn:hover {
        background: rgba(236, 189, 102, 0.3);
        transform: scale(1.1);
    }
    
    .pause-icon {
        display: flex;
        gap: 6px;
        align-items: center;
        justify-content: center;
    }
    
    .pause-bar {
        width: 6px;
        height: 24px;
        background: #E8E6E3;
        border-radius: 2px;
    }
    
    @media (max-width: 768px) {
        .apex-breathing-box {
            width: 250px;
            height: 250px;
        }
        
        .apex-breathing-ball {
            width: 20px;
            height: 20px;
        }
        
        .apex-breathing-text {
            font-size: 24px;
        }
        
        .apex-breathing-btn {
            width: 50px;
            height: 50px;
            font-size: 24px;
        }
        
        .pause-bar {
            width: 5px;
            height: 20px;
        }
        
        .apex-config-value {
            font-size: 48px;
        }
        
        .apex-config-title {
            font-size: 24px;
        }
    }
</style>

<div class="apex-breathing-trigger-wrapper">
    <button class="apex-breathing-trigger" onclick="apexOpenConfig()">
        Box Breathing starten
    </button>
</div>

<div class="apex-breathing-overlay" id="apexBreathingOverlay">
    <div class="apex-config-screen" id="apexConfigScreen">
        <div class="apex-config-title">Box Breathing</div>
        
        <div class="apex-config-controls">
            <button class="apex-triangle-btn up" onclick="apexAdjustDuration(1)"></button>
            
            <div>
                <div class="apex-config-value" id="apexDurationValue">4</div>
                <div class="apex-config-label">Sekunden pro Phase</div>
            </div>
            
            <button class="apex-triangle-btn down" onclick="apexAdjustDuration(-1)"></button>
        </div>
        
        <button class="apex-start-btn" onclick="apexStartBreathing()">Starten</button>
    </div>
    
    <div class="apex-breathing-screen" id="apexBreathingScreen">
        <div class="apex-breathing-container">
            <div class="apex-breathing-box">
                <div class="apex-breathing-fill" id="apexBreathingFill"></div>
                <div class="apex-breathing-text" id="apexBreathingText">Bereit</div>
                <div class="apex-breathing-ball" id="apexBreathingBall"></div>
            </div>
        </div>
        
        <div class="apex-breathing-controls">
            <button class="apex-breathing-btn" id="apexPauseBtn" onclick="apexTogglePause()">
                <div class="pause-icon" id="apexPauseIcon">
                    <div class="pause-bar"></div>
                    <div class="pause-bar"></div>
                </div>
            </button>
            <button class="apex-breathing-btn" onclick="apexStopBreathing()">✕</button>
        </div>
    </div>
</div>

<script>
(function() {
    let breathingInterval;
    let currentPhase = 0;
    let isPaused = false;
    let breathDuration = 4;
    let pausedTime = 0;
    let phaseStartTime = 0;
    let pausedBallPosition = { top: 0, left: 0 };
    let pausedFillHeight = 0;

    const phases = [
        { name: 'Inhale', targetTop: -12, targetLeft: -12, fill: 100 },
        { name: 'Hold', targetTop: -12, targetLeft: 'calc(100% - 12px)', fill: 100 },
        { name: 'Exhale', targetTop: 'calc(100% - 12px)', targetLeft: 'calc(100% - 12px)', fill: 0 },
        { name: 'Hold', targetTop: 'calc(100% - 12px)', targetLeft: -12, fill: 0 }
    ];

    window.apexOpenConfig = function() {
        document.getElementById('apexBreathingOverlay').classList.add('active');
        document.getElementById('apexConfigScreen').style.display = 'block';
        document.getElementById('apexBreathingScreen').classList.remove('active');
    };

    window.apexAdjustDuration = function(change) {
        breathDuration = Math.max(3, Math.min(8, breathDuration + change));
        document.getElementById('apexDurationValue').textContent = breathDuration;
    };

    window.apexStartBreathing = function() {
        document.getElementById('apexConfigScreen').style.display = 'none';
        document.getElementById('apexBreathingScreen').classList.add('active');
        
        currentPhase = 0;
        isPaused = false;
        pausedTime = 0;
        
        document.getElementById('apexPauseIcon').innerHTML = '<div class="pause-bar"></div><div class="pause-bar"></div>';
        
        const ball = document.getElementById('apexBreathingBall');
        const fill = document.getElementById('apexBreathingFill');
        ball.style.top = 'calc(100% - 12px)';
        ball.style.left = '-12px';
        fill.style.height = '0%';
        fill.style.transition = 'none';
        ball.style.transition = 'none';
        
        setTimeout(() => runPhase(), 500);
    };

    window.apexStopBreathing = function() {
        document.getElementById('apexBreathingOverlay').classList.remove('active');
        document.getElementById('apexBreathingScreen').classList.remove('active');
        clearTimeout(breathingInterval);
        isPaused = false;
        pausedTime = 0;
    };

    window.apexTogglePause = function() {
        const ball = document.getElementById('apexBreathingBall');
        const fill = document.getElementById('apexBreathingFill');
        const pauseIcon = document.getElementById('apexPauseIcon');
        
        if (!isPaused) {
            isPaused = true;
            pauseIcon.innerHTML = '▶';
            clearTimeout(breathingInterval);
            
            const ballStyle = window.getComputedStyle(ball);
            pausedBallPosition = {
                top: ballStyle.top,
                left: ballStyle.left
            };
            
            const fillStyle = window.getComputedStyle(fill);
            pausedFillHeight = fillStyle.height;
            
            ball.style.transition = 'none';
            fill.style.transition = 'none';
            ball.style.top = pausedBallPosition.top;
            ball.style.left = pausedBallPosition.left;
            fill.style.height = pausedFillHeight;
            
            pausedTime = Date.now() - phaseStartTime;
            
        } else {
            isPaused = false;
            pauseIcon.innerHTML = '<div class="pause-bar"></div><div class="pause-bar"></div>';
            
            const remainingTime = (breathDuration * 1000) - pausedTime;
            
            ball.style.transition = `all ${remainingTime / 1000}s linear`;
            fill.style.transition = `height ${remainingTime / 1000}s linear`;
            
            const phase = phases[currentPhase];
            ball.style.top = typeof phase.targetTop === 'number' ? phase.targetTop + 'px' : phase.targetTop;
            ball.style.left = typeof phase.targetLeft === 'number' ? phase.targetLeft + 'px' : phase.targetLeft;
            fill.style.height = phase.fill + '%';
            
            phaseStartTime = Date.now() - pausedTime;
            
            breathingInterval = setTimeout(() => {
                currentPhase = (currentPhase + 1) % 4;
                pausedTime = 0;
                runPhase();
            }, remainingTime);
        }
    };

    function runPhase() {
        if (isPaused) return;
        
        const phase = phases[currentPhase];
        const ball = document.getElementById('apexBreathingBall');
        const fill = document.getElementById('apexBreathingFill');
        const text = document.getElementById('apexBreathingText');
        
        text.textContent = phase.name;
        
        ball.style.transition = `all ${breathDuration}s linear`;
        fill.style.transition = `height ${breathDuration}s linear`;
        
        ball.style.top = typeof phase.targetTop === 'number' ? phase.targetTop + 'px' : phase.targetTop;
        ball.style.left = typeof phase.targetLeft === 'number' ? phase.targetLeft + 'px' : phase.targetLeft;
        fill.style.height = phase.fill + '%';
        
        phaseStartTime = Date.now();
        pausedTime = 0;
        
        breathingInterval = setTimeout(() => {
            if (!isPaused) {
                currentPhase = (currentPhase + 1) % 4;
                runPhase();
            }
        }, breathDuration * 1000);
    }
})();
</script>

